# History-Person 背景音乐噪声修复指南

## 🐛 问题描述

用户反映 history-person 模块合成的视频中背景音乐有噪声，原背景音乐文件本身是干净的。

## 🔍 问题根因

经过分析发现，问题出现在音频音量配置过高：

```javascript
// 问题配置（修复前）
CONFIG_AUDIO_VOLUME = {
  BACKGROUND_MUSIC_VOLUME: 10.0,  // ❌ 过高！音量放大10倍导致削峰失真
  VOICE_CLIP_VOLUME: 5.0,         // ❌ 过高！配音音量过大
  TYPEWRITER_SOUND_VOLUME: 2.0,   // ⚠️ 稍高，可能产生失真
}
```

### 技术原理

1. **FFmpeg volume 滤镜**：
   - `1.0` = 原始音量（100%）
   - `2.0` = 音量翻倍（200%）
   - `10.0` = 音量放大10倍（1000%）❌

2. **数字音频动态范围**：
   - 数字音频有固定的动态范围（通常是16位或24位）
   - 超出范围会发生削波（clipping），产生失真和噪声
   - 多轨混合时，各轨道音量总和不应超过100%

3. **音频削峰失真**：
   - 音量过高 → 信号超出数字范围 → 削波失真 → 听起来像噪声/破音

## ✅ 修复方案

已将所有音量调整到合理范围：

```javascript
// 修复后的配置
CONFIG_AUDIO_VOLUME = {
  BACKGROUND_MUSIC_VOLUME: 0.6,   // ✅ 背景音乐适中音量
  VOICE_CLIP_VOLUME: 1.2,         // ✅ 配音清晰但不过响
  ORIGINAL_AUDIO_VOLUME_WITH_BG: 0.8,  // ✅ 为背景音乐让路
  ORIGINAL_AUDIO_VOLUME_SOLO: 1.0,     // ✅ 无背景音乐时保持原音量
  TYPEWRITER_SOUND_VOLUME: 1.5,   // ✅ 音效适中
  BABY_CRY_VOLUME: 0.8,          // ✅ 保持不变
}
```

## 🎯 音量设置原则

### 推荐音量范围
- **背景音乐**: 0.4 - 0.8 （不抢夺主音频）
- **人声/配音**: 0.8 - 1.5 （清晰可听）
- **音效**: 0.5 - 1.5 （适度点缀）
- **原视频音频**: 0.8 - 1.0 （主要内容）

### 音量分配策略
```
总音量 ≤ 100% (1.0)
├── 原视频音频: 80% (0.8)
├── 背景音乐: 60% (0.6)
├── 配音: 120% (1.2) - 短时间，不与其他重叠
└── 音效: 150% (1.5) - 瞬间音效，突出效果
```

## 🧪 测试验证

### 测试命令
```bash
# 重新处理之前有噪声的视频
npx node-ffmpeg-tools history-person
```

### 验证要点
1. **背景音乐清晰度**：无破音、无失真、无噪声
2. **音量平衡**：各音轨层次分明，不相互干扰
3. **整体音质**：专业、干净、舒适的听感

### 对比测试
- **修复前**：背景音乐有明显噪声和破音
- **修复后**：背景音乐清晰干净，与原文件音质一致

## 🔧 自定义音量调整

如果需要进一步调整音量，可以修改 `history-person-constants.mjs`：

```javascript
export const CONFIG_AUDIO_VOLUME = {
  // 根据实际需求调整，但建议保持在合理范围内
  BACKGROUND_MUSIC_VOLUME: 0.6,  // 可调整为 0.4-0.8
  VOICE_CLIP_VOLUME: 1.2,        // 可调整为 0.8-1.5
  // ... 其他配置
};
```

## 🚨 注意事项

1. **避免音量过高**：任何音轨音量都不建议超过 2.0
2. **多轨混合**：多个音轨同时播放时，总音量容易超标
3. **音质优先**：宁可音量稍低，也要保证音质干净
4. **测试验证**：每次调整后都要测试实际效果

## 📊 常见问题

### Q: 为什么不能直接提高音量？
A: 数字音频有固定的动态范围，超出会产生不可逆的失真。正确做法是在后期制作时调整，或使用音频压缩/限制器。

### Q: 如何判断音量是否合适？
A: 
- 听感舒适，无破音
- 各音轨层次分明
- 与原始音频质量一致
- 在不同设备上播放效果稳定

### Q: 背景音乐太小声怎么办？
A: 
- 优先降低其他音轨音量
- 适度提高背景音乐音量（不超过1.0）
- 检查原始背景音乐文件的音量

## 🎉 预期效果

修复后的视频应该具有：
- ✅ 清晰干净的背景音乐
- ✅ 平衡协调的音量层次
- ✅ 专业级的音频质量
- ✅ 舒适的听觉体验

---

**修复完成时间**: 2025-11-07
**影响范围**: 所有使用 history-person 模块的视频处理
**向后兼容**: 完全兼容，无需修改现有配置
